---
title: "makrofaj"
author: "beyza"
date: "2023-02-21"
output: html_document
---

load libraries
```{r}
library(argparse)
library(findpython)
library(sp)
library(SeuratObject)
library(Seurat)
library(hdf5r)
library(devtools)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(patchwork)
library(devtools)
library(AUCell)
library(GSEABase)
library(Rtsne)
```



SeuratObject oluşturmak için
```{r}
GSM3489182_obj1 <- Read10X_h5(filename = "GSM3489182_Donor_01_filtered_gene_bc_matrices_h5.h5",
                             use.names = TRUE,
                             unique.features = TRUE)

GSM3489182_obj2 <- Read10X_h5(filename = "GSE122960/GSM3489185_Donor_02_filtered_gene_bc_matrices_h5.h5", 
                             use.names = TRUE,
                             unique.features = TRUE)
GSM3489182_obj3 <- Read10X_h5(filename = "GSM3489187_Donor_03_filtered_gene_bc_matrices_h5.h5", 
                             use.names = TRUE,
                             unique.features = TRUE)
GSM3489182_obj4 <- Read10X_h5(filename = "GSE122960/GSM3489189_Donor_04_filtered_gene_bc_matrices_h5.h5", 
                             use.names = TRUE,
                             unique.features = TRUE)
GSM3489182_obj5 <- Read10X_h5(filename = "GSE122960/GSM3489191_Donor_05_filtered_gene_bc_matrices_h5.h5",
                             use.names = TRUE,
                             unique.features = TRUE)

GSM3489182_obj6 <- Read10X_h5(filename = "GSE122960/GSM3489193_Donor_06_filtered_gene_bc_matrices_h5.h5", 
                             use.names = TRUE,
                             unique.features = TRUE)
GSM3489182_obj7 <- Read10X_h5(filename = "GSE122960/GSM3489195_Donor_07_filtered_gene_bc_matrices_h5.h5", 
                             use.names = TRUE,
                             unique.features = TRUE)
GSM3489182_obj8 <- Read10X_h5(filename = "TÜSEB/GSE122960/GSM3489197_Donor_08_filtered_gene_bc_matrices_h5.h5", 
                             use.names = TRUE,
                             unique.features = TRUE)

donor_1 <- CreateSeuratObject(counts = GSM3489182_obj1, project = "D1", min.cells = 3, min.features = 200)
donor_2 <- CreateSeuratObject(counts = GSM3489182_obj2, project = "D2", min.cells = 3, min.features = 200)
donor_3 <- CreateSeuratObject(counts = GSM3489182_obj3, project = "D3", min.cells = 3, min.features = 200)
donor_4 <- CreateSeuratObject(counts = GSM3489182_obj4, project = "D4", min.cells = 3, min.features = 200)
donor_5 <- CreateSeuratObject(counts = GSM3489182_obj5, project = "D5", min.cells = 3, min.features = 200)
donor_6 <- CreateSeuratObject(counts = GSM3489182_obj6, project = "D6", min.cells = 3, min.features = 200)
donor_7 <- CreateSeuratObject(counts = GSM3489182_obj7, project = "D7", min.cells = 3, min.features = 200)
donor_8 <- CreateSeuratObject(counts = GSM3489182_obj8, project = "D8", min.cells = 3, min.features = 200)

```





Seurat
1.MTReads
```{r}

donor_1[["percent.mt"]] <- PercentageFeatureSet(donor_1, pattern = "^MT-")
donor_2[["percent.mt"]] <- PercentageFeatureSet(donor_2, pattern = "^MT-")
donor_3[["percent.mt"]] <- PercentageFeatureSet(donor_3, pattern = "^MT-")
donor_4[["percent.mt"]] <- PercentageFeatureSet(donor_4, pattern = "^MT-")
donor_5[["percent.mt"]] <- PercentageFeatureSet(donor_5, pattern = "^MT-")
donor_6[["percent.mt"]] <- PercentageFeatureSet(donor_6, pattern = "^MT-")
donor_7[["percent.mt"]] <- PercentageFeatureSet(donor_7, pattern = "^MT-")
donor_8[["percent.mt"]] <- PercentageFeatureSet(donor_8, pattern = "^MT-")


VlnPlot(donor_1, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
VlnPlot(donor_2, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
VlnPlot(donor_3, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
VlnPlot(donor_4, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
VlnPlot(donor_5, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
VlnPlot(donor_6, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
VlnPlot(donor_7, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
VlnPlot(donor_8, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
```


2. filtering
```{r}

donor_1 <- subset(donor_1, subset =nFeature_RNA > 200 & nFeature_RNA <4500 & percent.mt < 17)
donor_2 <- subset(donor_2, subset =nFeature_RNA > 200 & nFeature_RNA <4500 & percent.mt < 17)
donor_3 <- subset(donor_3, subset =nFeature_RNA > 200 & nFeature_RNA <4500 & percent.mt < 17)
donor_4 <- subset(donor_4, subset =nFeature_RNA > 200 & nFeature_RNA <4500 & percent.mt < 17)
donor_5 <- subset(donor_5, subset =nFeature_RNA > 200 & nFeature_RNA <4500 & percent.mt < 17)
donor_6 <- subset(donor_6, subset =nFeature_RNA > 200 & nFeature_RNA <4500 & percent.mt < 17)
donor_7 <- subset(donor_7, subset =nFeature_RNA > 200 & nFeature_RNA <4500 & percent.mt < 17)
donor_8 <- subset(donor_8, subset =nFeature_RNA > 200 & nFeature_RNA <4500 & percent.mt < 17)
```

3. Normalize data
```{r}
#pbmc <- NormalizeData(pbmc, normalization.method = "LogNormalize", scale.factor = 10000)


donor_1 <- NormalizeData(donor_1)
donor_2 <- NormalizeData(donor_2)
donor_3 <- NormalizeData(donor_3)
donor_4 <- NormalizeData(donor_4)
donor_5 <- NormalizeData(donor_5)
donor_6 <- NormalizeData(donor_6)
donor_7 <- NormalizeData(donor_7)
donor_8 <- NormalizeData(donor_8)
```


4. Identify highly variable features
```{r}

donor_1 <- FindVariableFeatures(donor_1, selection.method = "vst", nfeatures = 2000)
donor_2 <- FindVariableFeatures(donor_2, selection.method = "vst", nfeatures = 2000)
donor_3 <- FindVariableFeatures(donor_3, selection.method = "vst", nfeatures = 2000)
donor_4 <- FindVariableFeatures(donor_4, selection.method = "vst", nfeatures = 2000)
donor_5 <- FindVariableFeatures(donor_5, selection.method = "vst", nfeatures = 2000)
donor_6 <- FindVariableFeatures(donor_6, selection.method = "vst", nfeatures = 2000)
donor_7 <- FindVariableFeatures(donor_7, selection.method = "vst", nfeatures = 2000)
donor_8 <- FindVariableFeatures(donor_8, selection.method = "vst", nfeatures = 2000)
```
integrate
liste <- list(donor_1, donor_2, donor_3, donor_4, donor_5, donor_6, donor_7, donor_8)
```{r}
liste <- list(donor_1, donor_2, donor_3, donor_4, donor_5)
Features <- SelectIntegrationFeatures(object.list = liste)
donors <- FindIntegrationAnchors(object.list = liste, anchor.features = Features)
donors <- IntegrateData(anchorset = donors)
```




5. Scaling
```{r}
all.genes <- rownames(donors)
donors <- ScaleData(donors, features = all.genes)
```


6.Perform linear dimensionality reduction
```{r}
donors <- RunPCA(donors, features = VariableFeatures(object = donors))
donors
```


EV ilgili genleri expression seviyesini görmek için
```{r}
features <- c("CD9", "CD63", "CD81", "PDCD6IP", "TSG101", "TSPAN6", "TSPAN8")
RidgePlot(Seurat_GSM3489182, features = features, ncol = 1)
VlnPlot(Seurat_GSM3489182, features = features)
```



tsne
```{r}
donors <- RunTSNE(
  donors,
  reduction = "pca",
  cells = NULL,
  dims = 1:5,
  features = NULL,
  seed.use = 1,
  tsne.method = "Rtsne",
  dim.embed = 2,
  distance.matrix = NULL,
  reduction.name = "tsne",
  reduction.key = "tSNE_"
)
DimPlot(donors, reduction = "tsne", group.by = "seurat_clusters")
```



umap
```{r}
donors <- FindNeighbors(donors, dims = 1:10)
donors <- FindClusters(donors, resolution = 0.1)
donors <- RunUMAP(donors, dims = 1:15)
DimPlot(donors, reduction = "umap", group.by = "orig.ident")

```


AUCELL iile Makrofajları bulmak için

For GeneSetrs

```{r}
genes2 <- unique(c("C1orf162", "C1QA", "CD74", "CLEC7A", "CTSC", "FCGR3A", "FN1", "GSTO1", "LIPA", "MARCH1", "NCF2", "S100A4", "SLC11A1", "TNFSF13B", "CD14", "CD68", "TFRC", "FCGR1A", "CCR5", "FCGR3A", "IL6", "APOC1", "CD163", "MRC1", "CD163", "CTSL", "CD5L", "GSDMD"))
geneSets2 <- GeneSet(genes2, setName="geneSet2")
exprMatrix2 <- donors
```

1. run
```{r}

exprMatrix2_atılacak <- exprMatrix2@assays$RNA@counts

cells_AUC2 <- AUCell_run(exprMatrix2_atılacak, geneSets2)
```


2. Determine the cells with the given gene signatures or active gene sets
```{r}
cells_assignment2 <- AUCell_exploreThresholds(cells_AUC2, plotHist=TRUE, assign=TRUE)
cells_assignment$Oligodendrocyte_Cahoy$aucThr$thresholds
```

3.
```{r}
library("ggplot2")
geneSetName2 <- rownames(cells_AUC2)[grep("geneSet2", rownames(cells_AUC2))]
AUCell_plotHist(cells_AUC2[geneSetName2,], aucThr=0.2)
abline(v=0.2)


```


4.
```{r}
quartz()
newSelectedCells2 <- names(which(getAUC(cells_AUC2)["geneSet2",]>0.2))

length(newSelectedCells2)
```



5. umap ile görüntülümek için
```{r}

exprMatrix2$is_ec2 <- ifelse(colnames(exprMatrix2) %in% newSelectedCells2, "macrophase", "non_macrophase")
exprMatrix2 <- RunUMAP(exprMatrix2, dims = 1:15)

DimPlot(reduction = "umap",object=exprMatrix2, group.by = "is_ec2", label = TRUE)

```


6. tsne ile görüntülemek için
```{r}

exprMatrix2$is_ec2 <- ifelse(colnames(exprMatrix2) %in% newSelectedCells2, "macrophase", "non_macrophase")
exprMatrix2 <- RunUMAP(exprMatrix2, dims = 1:15)

DimPlot(reduction = "tsne",object=exprMatrix2, group.by = "is_ec2", label = TRUE)

```



7. Seurattaki sınıflandırmaya göre makaleden bakarak makrofaj dışındakileri eleme
```{r}

macro<- subset(x = donors, subset = seurat_clusters == c("1"))
macro <- RunUMAP(macro, dims = 1:15)
DimPlot(reduction = "umap",object=macro, group.by = "orig.ident", label = TRUE)
```



Makrofajları AUCELL sonucuna göre subset etmek
```{r}

exprMatrix3 <- subset(x = exprMatrix2, subset = is_ec2 == "macrophase")
exprMatrix3 <- RunUMAP(exprMatrix3, dims = 1:15)
DimPlot(reduction = "umap",object=exprMatrix3, group.by = "orig.ident", label = TRUE)


```


-------------------------------------------------------------------------------------------------
Burası Toplam veriden AUCell ile EV pozitif olanları bulmak için






```{r}
genes <- unique(c("CD9", "CD63", "CD81", "PDCD6IP", "TSG101", "ARF6", "ANXA1", "CD82", "CD37", "VTA1", "CD80", "CD86", "SIRT6", "SDCBP", "TRIM5", "CLTC", "VPS4A", "VPS4B", "HSPA4", "HSPA1A", "HSPA4", "HSPA8", "HSPA1B" ,"HSPA5", "HSPA14", "HSPA2", "HSPA9", "HSPD1", "HSP90AA1", "HSP90AB1", "PLD1", "PLD2", "CD40", "CHMP4B", "CHMP4A", "CHMP4C", "FLOT1", "FLOT2", "ANXA2", "ANXA6", "ANXA4", "ANXA7", "CFL1", "CFL2", "PFN1", "PFN2"))
geneSets <- GeneSet(genes, setName="geneSet2")
exprMatrix <- donors
```

AUCell_run
```{r}
exprMatrix_atılacak <- exprMatrix@assays$RNA@counts

cells_AUC <- AUCell_run(exprMatrix_atılacak, geneSets)
```



1.1. Build gene-expression rankings for each cell
Her hücre için, genler en yüksekten en düşüğe doğru sıralanır. Aynı ifade değerine sahip genler karıştırılır. Bu nedenle, '0' ifadesine sahip genler, sıralamanın sonunda rastgele sıralanır.
```{r}
counts <- GetAssayData(object = exprMatrix, slot = "counts")
cells_rankings <- AUCell_buildRankings(counts)
cells_rankings
```



1.2. Calculate enrichment for the gene signatures (AUC)
```{r}
cells_AUC <- AUCell_calcAUC(geneSets, cells_rankings)
```


2. Determine the cells with the given gene signatures or active gene sets
2. neden boş????
```{r}
cells_assignment <- AUCell_exploreThresholds(cells_AUC, plotHist=TRUE, assign=TRUE)
cells_assignment$Oligodendrocyte_Cahoy$aucThr$thresholds
```




```{r}
library("ggplot2")
geneSetName <- rownames(cells_AUC)[grep("geneSet2", rownames(cells_AUC))]
AUCell_plotHist(cells_AUC[geneSetName,], aucThr=0.15)
abline(v=0.15)
```

```{r}
quartz()
newSelectedCells <- names(which(getAUC(cells_AUC)["geneSet2",]>0.15))
length(newSelectedCells)
```




```{r}
library("Seurat")
exprMatrix$is_ec <- ifelse(colnames(exprMatrix) %in% newSelectedCells, "EV", "non_EV")
DimPlot(reduction = "umap",object=exprMatrix, group.by = "is_ec", label = TRUE)
exprMatrix
```


----------------------------------------------------------------------------------------------------------------
BU KISIM MAKROFAJ OLARAK SEÇİLEN HÜCRELERDE EV POZİTİFLERİ BULMAK İÇİN




```{r}
genes3 <- unique(c("CD9", "CD63", "CD81", "PDCD6IP", "TSG101", "ARF6", "ANXA1", "CD82", "CD37", "VTA1", "CD80", "CD86", "SIRT6", "SDCBP", "TRIM5", "CLTC", "VPS4A", "VPS4B", "HSPA4", "HSPA1A", "HSPA4", "HSPA8", "HSPA1B" ,"HSPA5", "HSPA14", "HSPA2", "HSPA9", "HSPD1", "HSP90AA1", "HSP90AB1", "PLD1", "PLD2", "CD40", "CHMP4B", "CHMP4A", "CHMP4C", "FLOT1", "FLOT2", "ANXA2", "ANXA6", "ANXA4", "ANXA7", "CFL1", "CFL2", "PFN1", "PFN2",	"C1QA"))
geneSets3 <- GeneSet(genes3, setName="geneSet3")
exprMatrix3 <- macro
```

```{r}
exprMatrix_atılacak3 <- exprMatrix3@assays$RNA@counts

cells_AUC3 <- AUCell_run(exprMatrix_atılacak3, geneSets3)
```

```{r}

counts3 <- GetAssayData(object = exprMatrix3, slot = "counts")

```


2. Determine the cells with the given gene signatures or active gene sets
```{r}
cells_assignment3 <- AUCell_exploreThresholds(cells_AUC3, plotHist=TRUE, assign=TRUE)
cells_assignment3$Oligodendrocyte_Cahoy$aucThr$thresholds
```

```{r}
library("ggplot2")
geneSetName3 <- rownames(cells_AUC3)[grep("geneSet3", rownames(cells_AUC3))]
AUCell_plotHist(cells_AUC3[geneSetName3,], aucThr=0.19)
abline(v=0.19)


```

```{r}
quartz()
newSelectedCells3 <- names(which(getAUC(cells_AUC3)["geneSet3",]>0.18))

length(newSelectedCells3)
```


```{r}
library("Seurat")
exprMatrix3$is_ec3 <- ifelse(colnames(exprMatrix3) %in% newSelectedCells3, "EV", "non_EV")
exprMatrix3 <- RunUMAP(exprMatrix3, dims = 1:15)
DimPlot(reduction = "umap",object=exprMatrix3, group.by = "is_ec3", label = TRUE)


```

hangi hücre hangi donör
```{r}
DimPlot(reduction = "umap",object=exprMatrix3, group.by = "orig.ident", label = TRUE)
```





Differential gene expression

```{r}

suppressPackageStartupMessages({
    library(Seurat)
    library(dplyr)
    library(cowplot)
    library(ggplot2)
    library(pheatmap)
    library(enrichR)
    library(rafalib)
    library(Matrix)
    library(edgeR)

})
```


markers_all <- FindAllMarkers(exprMatrix3, test.use = "MAST", slot = "data")
```{r}
exprMatrix3 <- SetIdent(exprMatrix3, value = exprMatrix3@meta.data$is_ec3)
exprMatrix3@misc$markers <- FindAllMarkers(object = exprMatrix3, assay = 'RNA',only.pos = TRUE, test.use = 'MAST')
```
cluster oluşmuyor?????
```{r}
exprMatrix3@misc$markers %>%
    group_by(cluster) %>%
    top_n(n= -10, wt= p_val_adj) -> top10
top10
```


```{r}
mypar(2, 5, mar = c(4, 6, 3, 1))
for (i in unique(top10$cluster)) {
    barplot(sort(setNames(top10$avg_log2FC, top10$gene)[top10$cluster == i], F),
        horiz = T, las = 1, main = paste0(i, " vs. rest"), border = "white", yaxs = "i")
    abline(v = c(0, 0.25), lty = c(1, 2))
}
```


```{r}
markers_all %>%
    group_by(cluster) %>%
    top_n(-7, p_val_adj) -> top7

# create a scale.data slot for the selected genes
exprMatrix3 <- ScaleData(exprMatrix3, features = as.character(unique(top10$gene)), assay = "RNA")
DoHeatmap(exprMatrix3, features = as.character(unique(top10$gene)), group.by = "is_ec3",
    assay = "RNA")
```

```{r}
DotPlot(exprMatrix3, features = rev(as.character(unique(top10$gene))), group.by = "is_ec3",
    assay = "RNA") + coord_flip()
```

for ratio
```{r}

all <- as.data.frame(exprMatrix3@meta.data)
all_length <- nrow(all)

D1 <- filter(
  all,orig.ident == "D1")
D1_length <- nrow(D1)

D2 <- filter(
  all,orig.ident == "D2")
nrow(D2)
D2_length <- nrow(D2)

D3 <- filter(
  all,orig.ident == "D3")
nrow(D3)
D3_length <- nrow(D3)

D4 <- filter(
  all,orig.ident == "D4")
nrow(D4)
D4_length <- nrow(D4)

D5 <- filter(
  all,orig.ident == "D5")
nrow(D5)
D5_length <- nrow(D5)

ratio <- data_frame(D1 = D1_length/all_length,
                    D2 = D2_length/all_length,
                    D3 = D3_length/all_length,
                    D4 = D4_length/all_length,
                    D5 = D5_length/all_length)
```

